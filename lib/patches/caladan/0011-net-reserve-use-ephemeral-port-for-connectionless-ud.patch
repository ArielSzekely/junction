From 1e514f56834e870fe103e169ff7e65dce3a222b0 Mon Sep 17 00:00:00 2001
From: Josh Fried <joshuafried@gmail.com>
Date: Sun, 8 Jan 2023 07:17:07 -0500
Subject: [PATCH 11/11] net: reserve/use ephemeral port for connectionless udp
 sends

---
 runtime/net/defs.h      | 2 ++
 runtime/net/transport.c | 5 +++++
 runtime/net/udp.c       | 4 ++--
 3 files changed, 9 insertions(+), 2 deletions(-)

diff --git a/runtime/net/defs.h b/runtime/net/defs.h
index 07efdbf..56c8629 100644
--- a/runtime/net/defs.h
+++ b/runtime/net/defs.h
@@ -12,6 +12,8 @@
 
 #include "../defs.h"
 
+#define RESERVED_EPHEMERAL_UDP_PORT 65530
+
 extern struct mempool net_tx_buf_mp;
 
 
diff --git a/runtime/net/transport.c b/runtime/net/transport.c
index a6b7f68..3bd83e6 100644
--- a/runtime/net/transport.c
+++ b/runtime/net/transport.c
@@ -59,6 +59,11 @@ int trans_table_add(struct trans_entry *e)
 	if (e->laddr.port == 0)
 		return -EINVAL;
 
+	/* reserve one ephemeral port for UDP sends */
+	if (e->proto == IPPROTO_UDP &&
+	    e->laddr.port == RESERVED_EPHEMERAL_UDP_PORT)
+		return -EADDRINUSE;
+
 	assert(e->match == TRANS_MATCH_3TUPLE ||
 	       e->match == TRANS_MATCH_5TUPLE);
 	if (e->match == TRANS_MATCH_3TUPLE)
diff --git a/runtime/net/udp.c b/runtime/net/udp.c
index 994de6e..8074d28 100644
--- a/runtime/net/udp.c
+++ b/runtime/net/udp.c
@@ -675,7 +675,7 @@ ssize_t udp_send(const void *buf, size_t len,
 	else if (laddr.ip != netcfg.addr)
 		return -EINVAL;
 	if (laddr.port == 0)
-		return -EINVAL;
+		laddr.port = RESERVED_EPHEMERAL_UDP_PORT;
 
 	/* rewrite loopback address */
 	if (raddr.ip == MAKE_IP_ADDR(127, 0, 0, 1))
@@ -710,7 +710,7 @@ ssize_t udp_sendv(const struct iovec *iov, int iovcnt,
 	else if (laddr.ip != netcfg.addr)
 		return -EINVAL;
 	if (laddr.port == 0)
-		return -EINVAL;
+		laddr.port = RESERVED_EPHEMERAL_UDP_PORT;
 
 	/* rewrite loopback address */
 	if (raddr.ip == MAKE_IP_ADDR(127, 0, 0, 1))
-- 
2.34.1

